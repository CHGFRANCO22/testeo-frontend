<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Salud Total - Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      display: flex;
      background-color: #f4f6f9;
      color: #333;
      min-height: 100vh;
      overflow-x: hidden;
    }
    #sidebar {
      width: 240px;
      background: #2c3e50;
      color: white;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      padding-top: 60px;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    #sidebar.hide {
      transform: translateX(-240px);
    }
    #sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
    }
    #sidebar ul li {
      padding: 15px 25px;
      cursor: pointer;
      transition: background 0.3s;
      user-select: none;
      font-weight: 600;
      font-size: 1rem;
    }
    #sidebar ul li:hover,
    #sidebar ul li.active {
      background: #1abc9c;
      color: #fff;
    }
    #logoutBtn {
      background: #e74c3c;
      border: none;
      color: white;
      padding: 12px 25px;
      margin: 30px 25px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
      user-select: none;
      width: calc(100% - 50px);
      font-weight: 600;
      font-size: 1rem;
      align-self: center;
    }
    #logoutBtn:hover {
      background: #c0392b;
    }
    #toggle-btn {
      position: fixed;
      top: 10px;
      left: 10px;
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1100;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      user-select: none;
      transition: transform 0.3s ease, background 0.3s ease;
    }
    #toggle-btn:hover {
      transform: scale(1.05);
      background-color: #2980b9;
    }
    #content {
      margin-left: 240px;
      padding: 40px 40px 60px;
      width: 100%;
      transition: margin-left 0.3s ease;
      min-height: 100vh;
      background: #f4f6f9;
    }
    #content.fullwidth {
      margin-left: 0;
      padding: 40px 20px 60px;
    }
    .section {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      overflow: visible;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    h2 {
      margin-top: 0;
      color: #2c3e50;
      font-weight: 700;
      font-size: 1.8rem;
      margin-bottom: 20px;
    }
    h3 {
      margin-top: 0;
      color: #34495e;
      margin-bottom: 15px;
      font-weight: 600;
    }
    button {
      margin-right: 10px;
      padding: 10px 20px;
      border: none;
      background-color: #3498db;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
      user-select: none;
      font-weight: 600;
      font-size: 1rem;
    }
    button:hover {
      background-color: #2980b9;
    }
    input, select {
      display: block;
      margin-bottom: 15px;
      padding: 10px 12px;
      width: 100%;
      max-width: 320px;
      font-size: 1rem;
      border: 1.5px solid #ccc;
      border-radius: 6px;
      transition: border-color 0.3s;
    }
    input:focus, select:focus {
      border-color: #1abc9c;
      outline: none;
    }
    label {
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
      color: #34495e;
    }
    .paciente-box {
      margin-bottom: 10px;
      border-bottom: 1px solid #ccc;
      padding: 10px 0;
      position: relative;
      font-size: 1rem;
    }
    .acciones {
      margin-top: 8px;
    }
    .acciones button {
      padding: 6px 14px;
      font-size: 0.9rem;
    }
    .historial-turnos {
      background: #eef4fa;
      border-radius: 8px;
      margin-top: 10px;
      padding: 10px 15px;
      display: none;
      font-size: 14px;
      color: #2c3e50;
      white-space: pre-wrap;
    }
    .historial-turnos p {
      margin: 5px 0;
    }
    #formularioPaciente, #formularioTurno {
      max-width: 350px;
    }
  </style>
</head>
<body>

<button id="toggle-btn" aria-label="Toggle sidebar">☰</button>

<div id="sidebar">
  <ul id="menuList">
    <li onclick="showSection('pacientes')" class="active">Pacientes</li>
    <li onclick="showSection('turnos')">Turnos</li>
    <li onclick="showSection('agenda')">Agenda</li>
    <li onclick="showSection('perfil')">Perfil</li>
  </ul>
  <button id="logoutBtn">Cerrar sesión</button>
</div>

<div id="content">
  <!-- Sección Pacientes -->
  <div id="pacientes" class="section">
    <h2>Gestión de Pacientes</h2>
    <button onclick="listarPacientes()">Listar Pacientes</button>
    <button onclick="toggleFormulario()">Registrar Paciente</button>

    <div id="formularioPaciente" style="display:none; margin-top: 20px;">
      <h3>Nuevo Paciente</h3>
      <input type="text" id="nombre_completo" placeholder="Nombre completo" />
      <input type="text" id="dni" placeholder="DNI" />
      <input type="text" id="sexo" placeholder="Sexo" />
      <input type="number" id="edad" placeholder="Edad" min="0" max="150" />
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="contrasena" placeholder="Contraseña" />
      <button onclick="enviarFormularioPaciente()">Guardar</button>
    </div>

    <div id="pacientesResultado" style="margin-top: 20px;"></div>
  </div>

  <!-- Sección Turnos -->
  <div id="turnos" class="section" style="display:none">
    <h2>Turnos</h2>
    <button onclick="toggleFormularioTurno()">Nuevo Turno</button>

    <div id="formularioTurno" style="display:none; margin-top: 20px;">
      <h3>Registrar Turno</h3>

      <label for="selectPaciente">Paciente:</label>
      <select id="selectPaciente"></select>

      <label for="selectEspecialidad">Especialidad:</label>
      <select id="selectEspecialidad">
        <option value="">Seleccione especialidad</option>
        <option value="Clínica General">Clínica General</option>
        <option value="Pediatría">Pediatría</option>
        <option value="Cardiología">Cardiología</option>
        <option value="Ginecología">Ginecología</option>
      </select>

      <label for="selectProfesional">Profesional:</label>
      <select id="selectProfesional">
        <option value="">Seleccione profesional</option>
      </select>

      <label for="fechaTurno">Fecha y hora:</label>
      <input type="datetime-local" id="fechaTurno" />

      <button onclick="enviarFormularioTurno()">Guardar Turno</button>
    </div>

    <div id="turnosResultado" style="margin-top: 20px;"></div>
  </div>

  <!-- Sección Agenda -->
  <div id="agenda" class="section" style="display:none">
    <h2>Agenda Médica</h2>
    <p>Funcionalidad en desarrollo...</p>
  </div>

  <!-- Sección Perfil -->
  <div id="perfil" class="section" style="display:none">
    <h2>Perfil de Usuario</h2>
    <p>Funcionalidad en desarrollo...</p>
  </div>
</div>

<script>
  const token = localStorage.getItem("token");
  const usuario = JSON.parse(localStorage.getItem("usuario"));

  if (!token || !usuario) {
    window.location.href = "login.html";
  }

  // Mostrar/Ocultar menús según rol
  if (usuario.rol === "secretaria") {
    document.getElementById("pacientes")?.remove();
    document.getElementById("perfil")?.remove();
    const menu = document.getElementById("menuList");
    menu.querySelector("li[onclick=\"showSection('pacientes')\"]")?.remove();
    menu.querySelector("li[onclick=\"showSection('perfil')\"]")?.remove();
  }

  const sidebar = document.getElementById('sidebar');
  const toggleBtn = document.getElementById('toggle-btn');
  const content = document.getElementById('content');
  const sections = document.querySelectorAll('.section');
  const menuItems = document.querySelectorAll('#menuList li');

  toggleBtn.onclick = () => {
    sidebar.classList.toggle('hide');
    content.classList.toggle('fullwidth');
  };

  function showSection(sectionId) {
    sections.forEach(s => {
      s.style.display = s.id === sectionId ? 'block' : 'none';
    });
    // Marcar menú activo
    menuItems.forEach(li => {
      li.classList.toggle('active', li.getAttribute('onclick').includes(sectionId));
    });
  }

  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.clear();
    window.electronAPI.logout();
  });

  // === Pacientes ===
  let pacientesVisibles = false;

  function toggleFormulario() {
    const form = document.getElementById("formularioPaciente");
    const listado = document.getElementById("pacientesResultado");

    if (pacientesVisibles) {
      listado.innerHTML = '';
      pacientesVisibles = false;
    }

    form.style.display = form.style.display === "none" ? "block" : "none";
  }

  async function enviarFormularioPaciente() {
    const nombre_completo = document.getElementById("nombre_completo").value.trim();
    const dni = document.getElementById("dni").value.trim();
    const sexo = document.getElementById("sexo").value.trim();
    const edad = document.getElementById("edad").value.trim();
    const email = document.getElementById("email").value.trim();
    const contrasena = document.getElementById("contrasena").value.trim();

    if (!nombre_completo || !dni || !sexo || !edad || !email || !contrasena) {
      alert("Todos los campos son obligatorios.");
      return;
    }

    if (!email.includes("@") || !email.includes(".")) {
      alert("Email inválido.");
      return;
    }

    if (contrasena.length < 6) {
      alert("La contraseña debe tener al menos 6 caracteres.");
      return;
    }

    try {
      const res = await fetch("http://localhost:3000/api/pacientes", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ nombre_completo, dni, sexo, edad, email, contrasena }),
      });

      const data = await res.json();
      if (res.ok) {
        alert("Paciente registrado correctamente");
        document.getElementById("formularioPaciente").style.display = "none";
        listarPacientes();
      } else {
        alert(data.mensaje || "Error al registrar paciente");
      }
    } catch (err) {
      console.error("Error:", err);
      alert("Ocurrió un error al registrar el paciente.");
    }
  }

  async function listarPacientes() {
    const container = document.getElementById("pacientesResultado");
    const formulario = document.getElementById("formularioPaciente");

    if (pacientesVisibles) {
      container.innerHTML = '';
      pacientesVisibles = false;
      return;
    }

    formulario.style.display = "none";

    try {
      const res = await fetch("http://localhost:3000/api/pacientes", {
        headers: { Authorization: `Bearer ${token}` }
      });
      const pacientes = await res.json();

      container.innerHTML = '';
      pacientes.forEach(p => {
        const pacienteDiv = document.createElement('div');
        pacienteDiv.className = 'paciente-box';
        pacienteDiv.dataset.id = p.id_paciente;

        pacienteDiv.innerHTML = `
          <strong>${p.nombre_completo}</strong> - DNI: ${p.dni} - Edad: ${p.edad}
          <br><small>Email: ${p.email}</small>
          <div class="acciones">
            <button class="btn-historial">Historial</button>
            <button class="btn-eliminar" style="background:#e74c3c;">Eliminar</button>
          </div>
          <div class="historial-turnos"></div>
        `;

        container.appendChild(pacienteDiv);
      });

      pacientesVisibles = true;

      // Eventos historial
      document.querySelectorAll('.btn-historial').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const pacienteDiv = e.target.closest('.paciente-box');
          const historialDiv = pacienteDiv.querySelector('.historial-turnos');

          if (historialDiv.style.display === 'block') {
            historialDiv.style.display = 'none';
            historialDiv.innerHTML = '';
            return;
          }

          const idPaciente = pacienteDiv.dataset.id;

          try {
            const res = await fetch(`http://localhost:3000/api/turnos/paciente/${idPaciente}`, {
              headers: { Authorization: `Bearer ${token}` }
            });
            const turnos = await res.json();

            historialDiv.innerHTML = turnos.length > 0
              ? turnos.map(t =>
                  `<p>🗓️ <strong>${t.fecha_turno}</strong> - ${t.especialidad} con ${t.profesional}</p>`
                ).join('')
              : '<p>No hay turnos registrados para este paciente.</p>';

            historialDiv.style.display = 'block';
          } catch (err) {
            historialDiv.innerHTML = '<p>Error al cargar historial.</p>';
            historialDiv.style.display = 'block';
          }
        });
      });

      // Eventos eliminar paciente
      document.querySelectorAll('.btn-eliminar').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const pacienteDiv = e.target.closest('.paciente-box');
          const idPaciente = pacienteDiv.dataset.id;

          const confirmDelete = confirm('¿Estás seguro que quieres eliminar este paciente?');
          if (!confirmDelete) return;

          try {
            const res = await fetch(`http://localhost:3000/api/pacientes/${idPaciente}`, {
              method: 'DELETE',
              headers: { Authorization: `Bearer ${token}` }
            });

            if (res.ok) {
              pacienteDiv.remove();
            } else {
              alert('Error al eliminar paciente');
            }
          } catch (err) {
            alert('Error al eliminar paciente');
            console.error(err);
          }
        });
      });

    } catch (err) {
      console.error("Error al listar pacientes:", err);
    }
  }


  // === Turnos ===
  let turnosVisibles = false;

  function toggleFormularioTurno() {
    const form = document.getElementById("formularioTurno");
    const listado = document.getElementById("turnosResultado");

    if (turnosVisibles) {
      listado.innerHTML = "";
      turnosVisibles = false;
    }

    form.style.display = form.style.display === "none" ? "block" : "none";
    if (form.style.display === "block") {
      cargarPacientesParaTurno();
      cargarProfesionalesPorEspecialidad();
    }
  }

  async function cargarPacientesParaTurno() {
    const selectPaciente = document.getElementById("selectPaciente");
    selectPaciente.innerHTML = "<option>Cargando pacientes...</option>";

    try {
      const res = await fetch("http://localhost:3000/api/pacientes", {
        headers: { Authorization: `Bearer ${token}` },
      });
      const pacientes = await res.json();

      selectPaciente.innerHTML = `<option value="">Seleccione paciente</option>`;
      pacientes.forEach(p => {
        const option = document.createElement("option");
        option.value = p.id_paciente;
        option.textContent = `${p.nombre_completo} - DNI: ${p.dni}`;
        selectPaciente.appendChild(option);
      });
    } catch (err) {
      selectPaciente.innerHTML = `<option>Error al cargar pacientes</option>`;
    }
  }

  function cargarProfesionalesPorEspecialidad() {
    const selectEsp = document.getElementById("selectEspecialidad");
    const selectProf = document.getElementById("selectProfesional");

    selectProf.innerHTML = '<option value="">Seleccione profesional</option>';

    const profesionales = {
      "Clínica General": ["Dr. López", "Dra. Pérez"],
      "Pediatría": ["Dra. Gómez"],
      "Cardiología": ["Dr. Fernández", "Dra. Martínez"],
      "Ginecología": ["Dra. Ramírez"]
    };

    selectEsp.onchange = () => {
      const esp = selectEsp.value;
      selectProf.innerHTML = '<option value="">Seleccione profesional</option>';

      if (profesionales[esp]) {
        profesionales[esp].forEach(p => {
          const opt = document.createElement("option");
          opt.value = p;
          opt.textContent = p;
          selectProf.appendChild(opt);
        });
      }
    };
  }

  async function enviarFormularioTurno() {
    const idPaciente = document.getElementById("selectPaciente").value;
    const especialidad = document.getElementById("selectEspecialidad").value;
    const profesional = document.getElementById("selectProfesional").value;
    const fecha_turno = document.getElementById("fechaTurno").value;

    if (!idPaciente || !especialidad || !profesional || !fecha_turno) {
      alert("Por favor complete todos los campos del turno.");
      return;
    }

    try {
      const res = await fetch("http://localhost:3000/api/turnos", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ idPaciente, especialidad, profesional, fecha_turno }),
      });

      const data = await res.json();

      if (res.ok) {
        alert("Turno registrado correctamente");
        document.getElementById("formularioTurno").style.display = "none";
        listarTurnos();
      } else {
        alert(data.mensaje || "Error al registrar turno");
      }
    } catch (err) {
      console.error("Error al registrar turno:", err);
      alert("Ocurrió un error al registrar el turno.");
    }
  }

  async function listarTurnos() {
    const container = document.getElementById("turnosResultado");

    if (turnosVisibles) {
      container.innerHTML = "";
      turnosVisibles = false;
      return;
    }

    try {
      const res = await fetch("http://localhost:3000/api/turnos", {
        headers: { Authorization: `Bearer ${token}` },
      });
      const turnos = await res.json();

      if (!Array.isArray(turnos) || turnos.length === 0) {
        container.innerHTML = "<p>No hay turnos registrados.</p>";
      } else {
        container.innerHTML = turnos
          .map(
            (t) =>
              `<div style="border-bottom:1px solid #ccc; padding:10px 0;">
                <strong>Paciente:</strong> ${t.paciente_nombre || "N/A"}<br>
                <strong>Especialidad:</strong> ${t.especialidad}<br>
                <strong>Profesional:</strong> ${t.profesional}<br>
                <strong>Fecha:</strong> ${new Date(t.fecha_turno).toLocaleString()}
              </div>`
          )
          .join("");
      }

      turnosVisibles = true;
    } catch (err) {
      container.innerHTML = "<p>Error al cargar los turnos.</p>";
      console.error(err);
    }
  }

</script>

</body>
</html>
