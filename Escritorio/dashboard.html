<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Salud Total - Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      display: flex;
      background-color: #f4f6f9;
      color: #333;
    }
    #sidebar {
      width: 240px;
      background: #2c3e50;
      color: white;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      padding-top: 60px;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease;
      z-index: 1001;
    }
    #sidebar.hide {
      transform: translateX(-240px);
    }
    #sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #sidebar ul li {
      padding: 15px 25px;
      cursor: pointer;
      transition: background 0.3s;
      user-select: none;
    }
    #sidebar ul li:hover {
      background: #1abc9c;
    }
    #logoutBtn {
      background: #e74c3c;
      border: none;
      color: white;
      padding: 12px 25px;
      margin: 30px 25px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
      user-select: none;
      width: calc(100% - 50px);
    }
    #logoutBtn:hover {
      background: #c0392b;
    }
    #toggle-btn {
      position: fixed;
      top: 10px;
      left: 10px;
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1100;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      user-select: none;
      transition: transform 0.3s ease, background 0.3s ease;
    }
    #toggle-btn:hover {
      transform: scale(1.05);
      background-color: #2980b9;
    }
    #content {
      margin-left: 240px;
      padding: 40px;
      width: 100%;
      transition: margin-left 0.3s ease;
    }
    #content.fullwidth {
      margin-left: 0;
    }
    .section {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      overflow: visible;
    }
    h2 {
      margin-top: 0;
      color: #2c3e50;
    }
    button {
      margin-right: 10px;
      padding: 10px 20px;
      border: none;
      background-color: #3498db;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
      user-select: none;
    }
    button:hover {
      background-color: #2980b9;
    }
    .paciente-box {
      margin-bottom: 10px;
      border-bottom: 1px solid #ccc;
      padding: 10px 0;
      position: relative;
    }
    .acciones {
      margin-top: 8px;
    }
    .historial-turnos {
      background: #eef4fa;
      border-radius: 8px;
      margin-top: 10px;
      padding: 10px 15px;
      display: none;
      font-size: 14px;
      color: #2c3e50;
    }
    .historial-turnos p {
      margin: 5px 0;
    }
    #formularioPaciente input {
      display: block;
      margin-bottom: 10px;
      padding: 8px;
      width: 100%;
      max-width: 300px;
    }
  </style>
</head>
<body>

<button id="toggle-btn" aria-label="Toggle sidebar">‚ò∞</button>

<div id="sidebar">
  <ul id="menuList">
    <li onclick="showSection('pacientes')">Pacientes</li>
    <li onclick="showSection('turnos')">Turnos</li>
    <li onclick="showSection('agenda')">Agenda</li>
    <li onclick="showSection('perfil')">Perfil</li>
  </ul>
  <button id="logoutBtn">Cerrar sesi√≥n</button>
</div>

<div id="content">
  <div id="pacientes" class="section">
    <h2>Gesti√≥n de Pacientes</h2>
    <button onclick="listarPacientes()">Listar Pacientes</button>
    <button onclick="toggleFormulario()">Registrar Paciente</button>

    <div id="formularioPaciente" style="display:none; margin-top: 20px;">
      <h3>Nuevo Paciente</h3>
      <input type="text" id="nombre_completo" placeholder="Nombre completo">
      <input type="text" id="dni" placeholder="DNI">
      <input type="text" id="sexo" placeholder="Sexo">
      <input type="number" id="edad" placeholder="Edad">
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="contrasena" placeholder="Contrase√±a">
      <button onclick="enviarFormularioPaciente()">Guardar</button>
    </div>

    <div id="pacientesResultado" style="margin-top: 20px;"></div>
  </div>

  <div id="turnos" class="section" style="display:none">
    <h2>Turnos</h2>
  </div>

  <div id="agenda" class="section" style="display:none">
    <h2>Agenda M√©dica</h2>
  </div>

  <div id="perfil" class="section" style="display:none">
    <h2>Perfil de Usuario</h2>
  </div>
</div>

<script>
  const token = localStorage.getItem("token");
  const usuario = JSON.parse(localStorage.getItem("usuario"));
  if (!token || !usuario) {
    window.location.href = "login.html";
  }

  if (usuario.rol === "secretaria") {
    document.getElementById("pacientes")?.remove();
    document.getElementById("perfil")?.remove();
    const menu = document.getElementById("menuList");
    menu.querySelector("li[onclick=\"showSection('pacientes')\"]")?.remove();
    menu.querySelector("li[onclick=\"showSection('perfil')\"]")?.remove();
  }

  const sidebar = document.getElementById('sidebar');
  const toggleBtn = document.getElementById('toggle-btn');
  const content = document.getElementById('content');
  const sections = document.querySelectorAll('.section');

  toggleBtn.onclick = () => {
    sidebar.classList.toggle('hide');
    content.classList.toggle('fullwidth');
  };

  function showSection(sectionId) {
    sections.forEach(s => {
      s.style.display = s.id === sectionId ? 'block' : 'none';
    });
  }

  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.clear();
    window.electronAPI.logout();
  });

  let pacientesVisibles = false;

  function toggleFormulario() {
    const form = document.getElementById("formularioPaciente");
    const listado = document.getElementById("pacientesResultado");

    // Oculta el listado si est√° visible
    if (pacientesVisibles) {
      listado.innerHTML = '';
      pacientesVisibles = false;
    }

    form.style.display = form.style.display === "none" ? "block" : "none";
  }

  async function enviarFormularioPaciente() {
    const nombre_completo = document.getElementById("nombre_completo").value.trim();
    const dni = document.getElementById("dni").value.trim();
    const sexo = document.getElementById("sexo").value.trim();
    const edad = document.getElementById("edad").value.trim();
    const email = document.getElementById("email").value.trim();
    const contrasena = document.getElementById("contrasena").value.trim();

    if (!nombre_completo || !dni || !sexo || !edad || !email || !contrasena) {
      alert("Todos los campos son obligatorios.");
      return;
    }

    if (!email.includes("@") || !email.includes(".")) {
      alert("Email inv√°lido.");
      return;
    }

    if (contrasena.length < 6) {
      alert("La contrase√±a debe tener al menos 6 caracteres.");
      return;
    }

    try {
      const res = await fetch("http://localhost:3000/api/pacientes", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ nombre_completo, dni, sexo, edad, email, contrasena }),
      });

      const data = await res.json();
      if (res.ok) {
        alert("Paciente registrado correctamente");
        document.getElementById("formularioPaciente").style.display = "none";
        listarPacientes();
      } else {
        alert(data.mensaje || "Error al registrar paciente");
      }
    } catch (err) {
      console.error("Error:", err);
      alert("Ocurri√≥ un error al registrar el paciente.");
    }
  }

  async function listarPacientes() {
    const container = document.getElementById("pacientesResultado");
    const formulario = document.getElementById("formularioPaciente");

    // Si ya est√° visible, ocultar
    if (pacientesVisibles) {
      container.innerHTML = '';
      pacientesVisibles = false;
      return;
    }

    // Cerrar el formulario si est√° abierto
    formulario.style.display = "none";

    try {
      const res = await fetch("http://localhost:3000/api/pacientes", {
        headers: { Authorization: `Bearer ${token}` }
      });
      const pacientes = await res.json();

      container.innerHTML = '';
      pacientes.forEach(p => {
        const pacienteDiv = document.createElement('div');
        pacienteDiv.className = 'paciente-box';
        pacienteDiv.dataset.id = p.id_paciente;

        pacienteDiv.innerHTML = `
          <strong>${p.nombre_completo}</strong> - DNI: ${p.dni} - Edad: ${p.edad}
          <br><small>Email: ${p.email}</small>
          <div class="acciones">
            <button class="btn-historial">Historial</button>
            <button class="btn-eliminar" style="background:#e74c3c;">Eliminar</button>
          </div>
          <div class="historial-turnos"></div>
        `;

        container.appendChild(pacienteDiv);
      });

      pacientesVisibles = true;

      document.querySelectorAll('.btn-historial').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const pacienteDiv = e.target.closest('.paciente-box');
          const historialDiv = pacienteDiv.querySelector('.historial-turnos');

          if (historialDiv.style.display === 'block') {
            historialDiv.style.display = 'none';
            historialDiv.innerHTML = '';
            return;
          }

          const idPaciente = pacienteDiv.dataset.id;

          try {
            const res = await fetch(`http://localhost:3000/api/turnos/paciente/${idPaciente}`, {
              headers: { Authorization: `Bearer ${token}` }
            });
            const turnos = await res.json();

            historialDiv.innerHTML = turnos.length > 0
              ? turnos.map(t =>
                  `<p>üóìÔ∏è <strong>${t.fecha_turno}</strong> - ${t.especialidad} con ${t.profesional}</p>`
                ).join('')
              : '<p>No hay turnos registrados para este paciente.</p>';

            historialDiv.style.display = 'block';
          } catch (err) {
            historialDiv.innerHTML = '<p>Error al cargar historial.</p>';
            historialDiv.style.display = 'block';
          }
        });
      });

      document.querySelectorAll('.btn-eliminar').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const pacienteDiv = e.target.closest('.paciente-box');
          const idPaciente = pacienteDiv.dataset.id;

          const confirmDelete = confirm('¬øEst√°s seguro que quieres eliminar este paciente?');
          if (!confirmDelete) return;

          try {
            const res = await fetch(`http://localhost:3000/api/pacientes/${idPaciente}`, {
              method: 'DELETE',
              headers: { Authorization: `Bearer ${token}` }
            });

            if (res.ok) {
              pacienteDiv.remove();
            } else {
              alert('Error al eliminar paciente');
            }
          } catch (err) {
            alert('Error al eliminar paciente');
            console.error(err);
          }
        });
      });

    } catch (err) {
      console.error("Error al listar pacientes:", err);
    }
  }
</script>

</body>
</html>
